title: Implement tool recording/replay for test fixtures
milestone: Eval Setup
labels:
  - infrastructure
  - evals
depends_on:
  - Set up Promptfoo evaluation framework

body: |
  Record tool calls and responses from real agent runs, replay them in tests.

  ## Why Tool-Level Recording

  - **MCP-compatible**: Works with MCP servers where we don't control HTTP
  - **Tests agent reasoning**: Fixtures are what the agent sees, not internal HTTP
  - **Determinism**: Same tool responses on every test run
  - **Realistic**: Captured from real API interactions

  ## Recording Approach

  Capture tool invocations at the agent SDK level:

  ```typescript
  // Fixture format: request → response pairs
  {
    "tool": "strava_get_activities",
    "request": { "limit": 10, "after": "2024-01-01" },
    "response": { "activities": [...] }
  }
  ```

  ### Recording Mode

  ```typescript
  const tools = wrapToolsForRecording(mcpTools, {
    recordingsDir: 'fixtures/tools',
    mode: process.env.FIXTURE_MODE // 'record' | 'replay'
  });

  // Record: calls real tool, saves response to fixtures/
  // Replay: returns saved response, no tool call
  ```

  ### Matching Strategy

  Tool calls matched by:
  - Tool name (exact)
  - Request parameters (configurable: exact match, subset, or ignore)

  For non-deterministic params (timestamps, pagination), use parameter normalization or sequence-based matching.

  ## Tools Requiring Fixtures

  | Tool | Key Calls to Record |
  |------|---------------------|
  | Strava MCP | `get_activities`, `get_segments`, `get_athlete` |
  | GraphHopper | `route`, `elevation` |
  | WeatherKit | `forecast` (multiple locations/times) |
  | Google Maps MCP | `search_places`, `get_place_details` |
  | OSM Overpass | `query` (water fountains, bike infrastructure) |
  | PJAMM | `get_climb`, `search_climbs` |

  ## Privacy: Location Data

  Strava and route fixtures contain GPS coordinates. Before committing:

  - **Strava privacy zones**: Ensure enabled on account (API responses pre-scrubbed)
  - **Home radius scrub**: Truncate points within configured radius of home
  - **ID replacement**: Athlete IDs, names → placeholder values

  Coordinates outside home radius stay real (needed for integration with other tools).

  ## Fixture Structure

  ```
  fixtures/
  └── tools/
      ├── strava/
      │   ├── get_activities.json
      │   └── get_segments.json
      ├── graphhopper/
      │   └── route.json
      ├── weather/
      │   ├── forecast-sunny.json
      │   └── forecast-cold-to-warm.json
      └── places/
          └── search_places.json
  ```

  ## Integration with Promptfoo

  Promptfoo can use recorded fixtures via custom provider:

  ```yaml
  providers:
    - id: file://src/test/recorded-tools-provider.ts
      config:
        fixturesDir: fixtures/tools
  ```

  ## Deliverables

  - [ ] Implement tool wrapper for record/replay
  - [ ] Define fixture JSON schema
  - [ ] Create npm scripts: `fixtures:record`, `fixtures:replay`
  - [ ] Implement home location scrubbing for Strava fixtures
  - [ ] Record initial Strava fixtures
  - [ ] Record weather fixtures for clothing planning evals
  - [ ] Document recording workflow

  ## Success Criteria

  - `npm run evals` works offline
  - Same eval produces identical results on repeated runs
  - No home location exposed in committed fixtures
  - Easy to add fixtures for new scenarios

  ## Note on HTTP Recording (Polly.js)

  For tools implemented as direct HTTP calls (not MCP), Polly.js can still be used.
  But most tools will go through MCP, so tool-level recording is the primary approach.
