title: Implement HTTP recording/replay for test fixtures
milestone: Eval Setup
labels:
  - infrastructure
  - evals
depends_on:
  - Set up Promptfoo evaluation framework

body: |
  Use HTTP recording to capture real API responses and replay them in tests.

  ## Why Record/Replay

  - **Determinism**: Same responses on every test run
  - **Speed**: No network calls during tests
  - **Cost**: No API quota consumed
  - **Realistic**: Fixtures come from real APIs, not hand-crafted mocks
  - **Maintainable**: Re-record when APIs change instead of updating mocks

  ## Recommended: Polly.js

  Netflix's [Polly.js](https://netflix.github.io/pollyjs/) is purpose-built for this:

  ```typescript
  import { Polly } from '@pollyjs/core';
  import NodeHttpAdapter from '@pollyjs/adapter-node-http';
  import FSPersister from '@pollyjs/persister-fs';

  Polly.register(NodeHttpAdapter);
  Polly.register(FSPersister);

  const polly = new Polly('weather-api', {
    adapters: ['node-http'],
    persister: 'fs',
    persisterOptions: {
      fs: { recordingsDir: 'fixtures/recordings' }
    }
  });

  // First run: records real HTTP calls
  // Subsequent runs: replays from fixtures/recordings/
  ```

  ### Alternatives Considered

  | Tool | Pros | Cons |
  |------|------|------|
  | **Polly.js** | Purpose-built for record/replay, works with any HTTP client | Slightly more setup |
  | **Nock** (nockBack) | Familiar, simple API | Node.js only, manual adapter setup for some clients |
  | **MSW** | Great TypeScript support, browser+Node | No built-in recording |

  ## Recording Workflow

  1. **Record mode**: Run tests against real APIs, Polly captures responses
  2. **Replay mode**: Tests use recorded fixtures, no network calls
  3. **Update fixtures**: Re-record when APIs change or new scenarios needed

  ```bash
  # Record new fixtures
  POLLY_MODE=record npm run evals

  # Normal test runs (replay)
  npm run evals
  ```

  ## Tools Requiring Recordings

  | Tool | Recording Strategy |
  |------|-------------------|
  | Strava API | Record activity history, segments; scrub home location before commit |
  | WeatherKit | Record for specific locations/dates, create scenarios (sunny, rain, cold→warm) |
  | GraphHopper | Record route responses for test waypoints |
  | Google Maps | Record place searches for test areas |
  | OSM Overpass | Record infrastructure queries |
  | PJAMM | Record climb data for known climbs |

  ## Privacy: Location Data Scrubbing

  Strava and route fixtures contain GPS coordinates. Before committing:

  ### Home Location Scrubbing

  - **Configure home location**: Either set explicitly or prompt user during recording
  - **Scrub radius**: Remove/truncate points within configured radius of home (similar to Strava's privacy zone)
  - **Strava privacy zones**: If enabled on account, API responses may already exclude sensitive areas

  ### What Gets Scrubbed

  - First/last N points of activities within home radius
  - Exact start/end coordinates replaced with nearest major intersection or landmark
  - Athlete IDs, names replaced with placeholder values

  ### What Stays Real

  - Route shape and elevation profile (needed for realistic testing)
  - Segment data and timestamps (shifted if needed)
  - All coordinates outside home radius (needed for API integration)

  ## Fixture Structure

  ```
  fixtures/
  └── recordings/           # Polly.js auto-generated
      ├── strava/
      ├── weather-api/
      ├── graphhopper/
      ├── google-maps/
      └── osm-overpass/
  ```

  ## Deliverables

  - [ ] Install Polly.js and adapters
  - [ ] Configure recording directory structure
  - [ ] Create npm scripts for record vs replay modes
  - [ ] Implement home location scrubbing for Strava fixtures
  - [ ] Record initial fixtures for WeatherKit (highest priority for Clothing Planning evals)
  - [ ] Record Strava fixtures (with privacy scrubbing)
  - [ ] Record GraphHopper fixtures for route tests
  - [ ] Document recording workflow

  ## Success Criteria

  - `npm run evals` works offline (airplane mode)
  - Same eval produces identical results on repeated runs
  - No home location exposed in committed fixtures
  - Clear workflow for updating fixtures when needed
